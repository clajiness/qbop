services:
  qbop:
    image: ghcr.io/clajiness/qbop
    container_name: qbop
    restart: unless-stopped
    volumes:
      - data:/opt/qbop/data/
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
    # This value determines how often the script runs. The default is 45 seconds. This value is recommended by ProtonVPN.
      - QBOP_JOB_FREQ=
    # The number of loops with a new forwarded port before updating OPNsense and qBit. The default is 3, min is 1, and max is 10.
      - REQUIRED_ATTEMPTS=
    # Default is `10.2.0.1`. Do not use http(s):// or a trailing slash.
      - PROTON_GATEWAY=
    # OPNsense Interface Address. Requires http(s):// and no trailing slash.
      - OPN_INTERFACE_ADDR=
    # OPNsense API Key
      - OPN_API_KEY=
    # OPNsense API Secret
      - OPN_API_SECRET=
    # The firewall alias that you use for ProtonVPN's forwarded port. For example, `proton_vpn_forwarded_port`.
      - OPN_PROTON_ALIAS_NAME=
    # [`true`/`false`] Skip qBittorrent. If `true`, subsequent qBit environment variables are not required.
      - QBIT_SKIP=
    # The IP address of your qBittorrent app. Requires http(s):// and no trailing slash.
      - QBIT_ADDR=
    # qBittorrent username
      - QBIT_USER=
    # qBittorrent password
      - QBIT_PASS=
  
  redis:
    image: redis:7.4.2
    container_name: qbop-redis
    restart: unless-stopped
    command: ["redis-server"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 1s
      timeout: 3s
      retries: 5
  
  sidekiq:
    depends_on:
      - qbop
      - redis
    build: .
    command: bundle exec sidekiq -r ./jobs/qbop.rb

volumes:
  data:
  redis_data:
